# MCTS Track Reconstruction

## Overview

This repository contains an implementation of a novel track reconstruction algorithm based on the [Monte Carlo tree search](https://en.wikipedia.org/wiki/Monte_Carlo_tree_search) for the [TrackML detector](https://www.kaggle.com/competitions/trackml-particle-identification). Scrips that need to be modified will have blocks of code marked by `# BEGIN INPUT` and `# END INPUT`, which delineate the parts you need to modify, typically paths and parameters.

Johannes Wagner (UC Berkeley) \<johannes_wagner@berkeley.edu\>  
Max Zhao (UC Berkeley) \<zhaomax2@gmail.com\>

## Full Sequence

### 1. Generate a dataset

This project is designed to use data generated with [ACTS](https://acts.readthedocs.io/en/latest/), so ACTS needs to be installed. If you choose not to use ACTS, skip the first two steps and ensure that your datafiles are in the same format as described later. Otherwise, verify your ACTS python bindings and run `python generate_pp.py --acts_dir ACTSDIR --out_dir OUTDIR`, where ACTSDIR is the path to your installation of ACTS and OUTDIR is the path where you want the data to be put.

### 2. Preprocess the dataset

`add_measurements.py`

### 3. Generate quadruplets

#### How to run

To run the quadruplet generator, you will need to download the detectors file from [TrackML Challenge](https://www.kaggle.com/competitions/trackml-particle-identification/data). When unpacked it will be a file named `detectors.csv`, and it is a list of all the modules in the detector and their orientation and dimensions. Now modify the script `triplet_generator.py`, setting `hits_path` to the path to your measurements file, `detector_path` to the path to `detectors.csv`, `outdir` to the path you want the quadruplets to end up, and `events` to the events that you want to run on. Running `triplet_generator.py` should now produce the training data for the policy network, but be warned that this is not a very efficient script.

#### Implementation details

The quadruplets are generated by truth tracking. We start with truth triplet seeds generated by `truth_seeds()`. Now the script iteratively builds up truth tracks. At each step, we take the last three hits of the truth track, fit a helix through their truth positions and find where this helix next intersects a layer. This helix logic is all implemented in the `helices.py` package described in the appendix. After finding this helix intersection, we take an area around the intersection and add to the quadruplets the original 3 hits at the end of the track plus the candidate hit in the area around the intersection. If a hit matching the particle ID of the last three hits is found, we append that to our truth track and repeat the process. At the end, we have a large collection of hit quadruplets where the first three hits are from the same track and the fourth is plausible. Running the script will produce a file `histograms.csv` that is simply two histograms of the distances between from the helix intersection for matches and non-matches.

### 4. Train policy

### 5. Train evaluation

### 6. Run MCTS

## Appendix

### Helices

### utils